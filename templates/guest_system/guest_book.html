{% extends 'guest_system/base.html' %} {% load static %} {% block title %}Buku
Tamu - Smart Guest Book {% endblock %}{% block content %}
<div class="card-3d">
  <div class="guestbook-header">
    <h2><i class="fas fa-book"></i> Buku Tamu Digital</h2>
    <p>Silakan lengkapi informasi kunjungan Anda</p>
  </div>

  {% if guest %}
  <div class="guest-info-card">
    <div class="guest-avatar">
      {% if guest.face_image %}
      <img src="{{ guest.face_image.url }}" alt="Foto {{ guest.name }}" />
      {% else %}
      <i class="fas fa-user-circle"></i>
      {% endif %}
    </div>
    <div class="guest-details">
      <h3>{{ guest.name }}</h3>
      <div class="guest-meta">
        {% if guest.email %}
        <span><i class="fas fa-envelope"></i> {{ guest.email }}</span>
        {% endif %} {% if guest.phone %}
        <span><i class="fas fa-phone"></i> {{ guest.phone }}</span>
        {% endif %} {% if guest.company %}
        <span><i class="fas fa-building"></i> {{ guest.company }}</span>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <div class="purpose-display">
    <h4><i class="fas fa-target"></i> Tujuan Kunjungan:</h4>
    <div class="purpose-badge" id="purpose-badge">
      <!-- Will be populated by JavaScript -->
    </div>
  </div>

  <form id="guestbook-form" class="guestbook-form">
    {% csrf_token %}
    <input type="hidden" id="guest-id" name="guest_id" value="{{ guest.id }}" />
    <input type="hidden" id="visit-purpose" name="purpose" />

    <div class="form-section">
      <h4><i class="fas fa-edit"></i> Detail Kunjungan</h4>

      <div class="form-group">
        <label for="visit-description" class="form-label-top">
          <i class="fas fa-comment-alt"></i>
          Jelaskan tujuan kunjungan Anda secara detail *
        </label>
        <textarea
          id="visit-description"
          name="description"
          class="form-textarea"
          rows="5"
          placeholder="Contoh: Ingin mengurus surat keterangan domisili untuk keperluan pendaftaran sekolah anak..."
          required
        ></textarea>
        <div class="char-counter">
          <span id="char-count">0</span>/500 karakter
        </div>
      </div>

      <!-- Enhanced Custom Select for Duration -->
      <div class="form-group">
        <label for="expected-duration" class="form-label-top">
          <i class="fas fa-clock"></i>
          Estimasi Waktu Kunjungan
        </label>
        <div class="custom-select-wrapper">
          <div class="custom-select" id="duration-select">
            <div class="select-trigger">
              <span class="select-placeholder">Pilih estimasi waktu</span>
              <div class="select-arrow">
                <i class="fas fa-chevron-down"></i>
              </div>
            </div>
            <div class="select-options">
              <div class="select-option" data-value="">
                <div class="option-content">
                  <i class="fas fa-clock"></i>
                  <span>Pilih estimasi waktu</span>
                </div>
              </div>
              <div class="select-option" data-value="15">
                <div class="option-content">
                  <i class="fas fa-clock"></i>
                  <span>15 menit</span>
                  <small>Urusan cepat</small>
                </div>
              </div>
              <div class="select-option" data-value="30">
                <div class="option-content">
                  <i class="fas fa-clock"></i>
                  <span>30 menit</span>
                  <small>Konsultasi singkat</small>
                </div>
              </div>
              <div class="select-option" data-value="60">
                <div class="option-content">
                  <i class="fas fa-clock"></i>
                  <span>1 jam</span>
                  <small>Urusan standar</small>
                </div>
              </div>
              <div class="select-option" data-value="120">
                <div class="option-content">
                  <i class="fas fa-clock"></i>
                  <span>2 jam</span>
                  <small>Urusan kompleks</small>
                </div>
              </div>
              <div class="select-option" data-value="240">
                <div class="option-content">
                  <i class="fas fa-hourglass-half"></i>
                  <span>Lebih dari 2 jam</span>
                  <small>Urusan khusus</small>
                </div>
              </div>
            </div>
          </div>
          <!-- Hidden input for form submission -->
          <input type="hidden" id="expected-duration" name="expected_duration" />
        </div>
      </div>

      <div class="form-group">
        <label for="urgency-level" class="form-label-top">
          <i class="fas fa-exclamation-triangle"></i>
          Tingkat Urgensi
        </label>
        <div class="urgency-options">
          <label class="urgency-option">
            <input type="radio" name="urgency" value="low" checked />
            <span class="urgency-indicator low"></span>
            <span class="urgency-text">Rendah</span>
          </label>
          <label class="urgency-option">
            <input type="radio" name="urgency" value="medium" />
            <span class="urgency-indicator medium"></span>
            <span class="urgency-text">Sedang</span>
          </label>
          <label class="urgency-option">
            <input type="radio" name="urgency" value="high" />
            <span class="urgency-indicator high"></span>
            <span class="urgency-text">Tinggi</span>
          </label>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn-3d btn-submit">
        <i class="fas fa-check-circle"></i>
        Selesai & Masuk
      </button>
      <a
        href="{% url 'guest_system:gesture_recognition' %}?guest_id={{ guest.id }}"
        class="btn-secondary"
      >
        <i class="fas fa-arrow-left"></i>
        Kembali
      </a>
    </div>
  </form>
</div>

<!-- Success Modal -->
<div id="success-modal" class="modal" style="display: none">
  <div class="modal-content card-3d success-modal">
    <div class="success-animation">
      <i class="fas fa-check-circle"></i>
    </div>
    <h3>Selamat Datang!</h3>
    <p>Buku tamu berhasil diisi. Terima kasih atas kunjungan Anda.</p>
    <div id="direction-display" class="direction-info">
      <!-- Direction will be populated here -->
    </div>
    <div class="success-actions">
      <button class="btn-3d" onclick="finishProcess()">
        <i class="fas fa-home"></i>
        Selesai
      </button>
    </div>
  </div>
</div>
{% endblock %} 

{% block extra_css %}
<style>
  .guestbook-header {
    text-align: center;
    margin-bottom: 30px;
  }

  .guestbook-header h2 {
    color: #a6a9afff;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    font-size: 2rem;
  }

  .guestbook-header p {
    color: #a6a9afff;
    font-size: 1.1rem;
  }

  .guest-info-card {
    display: flex;
    align-items: center;
    gap: 20px;
    background: rgba(102, 126, 234, 0.05);
    border: 1px solid rgba(102, 126, 234, 0.1);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 30px;
  }

  .guest-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    overflow: hidden;
    background: rgba(102, 126, 234, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    border: 3px solid rgba(102, 126, 234, 0.2);
  }

  .guest-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .guest-avatar i {
    font-size: 2.5rem;
    color: #667eea;
  }

  .guest-details h3 {
    color: #a6a9afff;
    margin-bottom: 10px;
    font-size: 1.5rem;
    font-weight: 600;
  }

  .guest-meta {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .guest-meta span {
    color: #6b7280;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .guest-meta i {
    width: 16px;
    color: #667eea;
  }

  .btn-secondary {
    background: rgba(107, 114, 128, 0.1);
    color: #6b7280;
    border: 2px solid rgba(107, 114, 128, 0.2);
    padding: 12px 24px;
    border-radius: 12px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .btn-secondary:hover {
    background: rgba(107, 114, 128, 0.2);
    border-color: rgba(107, 114, 128, 0.3);
    transform: translateY(-2px);
  }

  .purpose-display {
    margin-bottom: 30px;
  }

  .purpose-display h4 {
    color: #a6a9afff;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.2rem;
  }

  .purpose-badge {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 12px 20px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1.1rem;
  }

  .purpose-badge.data-service {
    background: rgba(34, 197, 94, 0.1);
    color: #059669;
    border: 1px solid rgba(34, 197, 94, 0.2);
  }

  .purpose-badge.meet-staff {
    background: rgba(59, 130, 246, 0.1);
    color: #2563eb;
    border: 1px solid rgba(59, 130, 246, 0.2);
  }

  .form-section {
    background: rgba(255, 255, 255, 0.5);
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid rgba(0, 0, 0, 0.05);
  }

  .form-section h4 {
    color: #374151;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.3rem;
    padding-bottom: 10px;
    border-bottom: 2px solid rgba(102, 126, 234, 0.1);
  }

  .form-label-top {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #374151;
    font-weight: 500;
    margin-bottom: 8px;
    font-size: 1rem;
  }

  .form-textarea {
    width: 100%;
    padding: 16px;
    border: 2px solid rgba(102, 126, 234, 0.1);
    border-radius: 12px;
    font-size: 1rem;
    font-family: inherit;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    outline: none;
    resize: vertical;
    min-height: 120px;
  }

  .form-textarea:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    background: rgba(255, 255, 255, 0.95);
  }

  .char-counter {
    text-align: right;
    margin-top: 5px;
    font-size: 0.85rem;
    color: #6b7280;
  }

  /* ===== ENHANCED CUSTOM SELECT STYLES ===== */
  .custom-select-wrapper {
    position: relative;
    width: 100%;
  }

  .custom-select {
    position: relative;
    width: 100%;
    cursor: pointer;
  }

  .select-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(102, 126, 234, 0.1);
    border-radius: 12px;
    font-size: 1rem;
    color: #374151;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
  }

  .select-trigger:hover {
    border-color: rgba(102, 126, 234, 0.3);
    box-shadow: 0 4px 8px rgba(102, 126, 234, 0.1);
    transform: translateY(-1px);
  }

  .custom-select.active .select-trigger {
    border-color: #667eea;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    background: rgba(255, 255, 255, 0.95);
  }

  .select-placeholder {
    color: #9ca3af;
    font-weight: 400;
  }

  .select-trigger.has-value .select-placeholder {
    color: #374151;
    font-weight: 500;
  }

  .select-arrow {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 6px;
    transition: all 0.3s ease;
  }

  .select-arrow i {
    color: #667eea;
    font-size: 0.8rem;
    transition: transform 0.3s ease;
  }

  .custom-select.active .select-arrow {
    background: #667eea;
  }

  .custom-select.active .select-arrow i {
    color: white;
    transform: rotate(180deg);
  }

  .select-options {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border: 2px solid rgba(102, 126, 234, 0.1);
    border-top: none;
    border-radius: 0 0 12px 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    max-height: 280px;
    overflow-y: auto;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .custom-select.active .select-options {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .select-option {
    padding: 0;
    cursor: pointer;
    transition: all 0.2s ease;
    border-bottom: 1px solid rgba(102, 126, 234, 0.05);
  }

  .select-option:last-child {
    border-bottom: none;
  }

  .select-option:hover {
    background: rgba(102, 126, 234, 0.05);
  }

  .select-option.selected {
    background: rgba(102, 126, 234, 0.1);
  }

  .option-content {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px;
    position: relative;
  }

  .option-content i {
    color: #667eea;
    font-size: 1rem;
    width: 20px;
    text-align: center;
  }

  .option-content span {
    font-weight: 500;
    color: #374151;
    flex: 1;
  }

  .option-content small {
    color: #6b7280;
    font-size: 0.8rem;
    font-weight: 400;
    opacity: 0.8;
  }

  .select-option:hover .option-content i {
    color: #4f46e5;
    transform: scale(1.1);
  }

  .select-option:hover .option-content span {
    color: #1f2937;
  }

  .select-option.selected .option-content {
    position: relative;
  }

  .select-option.selected .option-content::after {
    content: "✓";
    position: absolute;
    right: 16px;
    color: #10b981;
    font-weight: bold;
    font-size: 1.1rem;
  }

  /* Custom scrollbar for select options */
  .select-options::-webkit-scrollbar {
    width: 6px;
  }

  .select-options::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 3px;
  }

  .select-options::-webkit-scrollbar-thumb {
    background: rgba(102, 126, 234, 0.3);
    border-radius: 3px;
  }

  .select-options::-webkit-scrollbar-thumb:hover {
    background: rgba(102, 126, 234, 0.5);
  }

  /* ===== END CUSTOM SELECT STYLES ===== */

  .urgency-options {
    display: flex;
    gap: 15px;
    margin-top: 10px;
  }

  .urgency-option {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 12px 16px;
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.5);
    border: 1px solid rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    flex: 1;
    justify-content: center;
  }

  .urgency-option:hover {
    background: rgba(255, 255, 255, 0.8);
  }

  .urgency-option input[type="radio"] {
    display: none;
  }

  .urgency-option
    input[type="radio"]:checked
    + .urgency-indicator
    + .urgency-text {
    font-weight: 600;
  }

  .urgency-option input[type="radio"]:checked + .urgency-indicator.low {
    background: #10b981;
  }

  .urgency-option input[type="radio"]:checked + .urgency-indicator.medium {
    background: #f59e0b;
  }

  .urgency-option input[type="radio"]:checked + .urgency-indicator.high {
    background: #ef4444;
  }

  .urgency-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #d1d5db;
    transition: all 0.3s ease;
  }

  .urgency-indicator.low {
    border: 2px solid #10b981;
  }

  .urgency-indicator.medium {
    border: 2px solid #f59e0b;
  }

  .urgency-indicator.high {
    border: 2px solid #ef4444;
  }

  .urgency-text {
    color: #374151;
    font-size: 0.95rem;
    transition: all 0.3s ease;
  }

  .form-actions {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 30px;
  }

  .btn-submit {
    font-size: 1.2rem;
    padding: 18px 36px;
  }

  .success-modal {
    text-align: center;
    max-width: 500px;
  }

  .success-animation {
    font-size: 4rem;
    color: #10b981;
    margin-bottom: 20px;
    animation: successPulse 1s ease-in-out;
  }

  @keyframes successPulse {
    0% {
      transform: scale(0);
      opacity: 0;
    }
    50% {
      transform: scale(1.2);
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  .success-modal h3 {
    color: #374151;
    margin-bottom: 15px;
    font-size: 2rem;
  }

  .success-modal p {
    color: #6b7280;
    margin-bottom: 25px;
    font-size: 1.1rem;
    line-height: 1.5;
  }

  .direction-info {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.2);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
  }

  .direction-info h4 {
    color: #059669;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .direction-info p {
    color: #374151;
    font-weight: 500;
    margin: 0;
  }

  .success-actions {
    display: flex;
    justify-content: center;
  }

  @media (max-width: 768px) {
    .guest-info-card {
      flex-direction: column;
      text-align: center;
    }

    .guest-meta {
      align-items: center;
    }

    .urgency-options {
      flex-direction: column;
    }

    .form-actions {
      flex-direction: column;
      align-items: center;
    }

    .select-options {
      max-height: 200px;
    }
  }
</style>
{% endblock %} 

{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Get purpose from URL and set up the page
    const urlParams = new URLSearchParams(window.location.search);
    const purpose = urlParams.get("purpose");

    setupPurposeDisplay(purpose);
    setupCharacterCounter();
    setupCustomSelect();
    setupFormSubmission();
  });

  function setupPurposeDisplay(purpose) {
    const purposeBadge = document.getElementById("purpose-badge");
    const visitPurposeInput = document.getElementById("visit-purpose");

    visitPurposeInput.value = purpose;

    if (purpose === "data_service") {
      purposeBadge.innerHTML = '<i class="fas fa-database"></i> Pelayanan Data';
      purposeBadge.className = "purpose-badge data-service";
    } else if (purpose === "meet_staff") {
      purposeBadge.innerHTML =
        '<i class="fas fa-users"></i> Menemui Pegawai/Kepala Kantor';
      purposeBadge.className = "purpose-badge meet-staff";
    }
  }

  function setupCharacterCounter() {
    const textarea = document.getElementById("visit-description");
    const charCount = document.getElementById("char-count");
    const maxLength = 500;

    textarea.addEventListener("input", function () {
      const currentLength = this.value.length;
      charCount.textContent = currentLength;

      if (currentLength > maxLength * 0.9) {
        charCount.style.color = "#ef4444";
      } else if (currentLength > maxLength * 0.7) {
        charCount.style.color = "#f59e0b";
      } else {
        charCount.style.color = "#6b7280";
      }

      // Prevent exceeding max length
      if (currentLength > maxLength) {
        this.value = this.value.substring(0, maxLength);
        charCount.textContent = maxLength;
      }
    });
  }

  function setupCustomSelect() {
    const customSelect = document.getElementById('duration-select');
    const selectTrigger = customSelect.querySelector('.select-trigger');
    const selectOptions = customSelect.querySelector('.select-options');
    const hiddenInput = document.getElementById('expected-duration');
    const placeholder = selectTrigger.querySelector('.select-placeholder');

    // Toggle dropdown
    selectTrigger.addEventListener('click', function() {
      customSelect.classList.toggle('active');
      
      // Close other selects if any
      document.querySelectorAll('.custom-select').forEach(select => {
        if (select !== customSelect) {
          select.classList.remove('active');
        }
      });
    });

    // Handle option selection
    selectOptions.addEventListener('click', function(e) {
      const option = e.target.closest('.select-option');
      if (!option) return;

      const value = option.dataset.value;
      const text = option.querySelector('span').textContent;

      // Update display
      placeholder.textContent = text;
      selectTrigger.classList.add('has-value');
      
      // Update hidden input
      hiddenInput.value = value;

      // Update selected state
      selectOptions.querySelectorAll('.select-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      option.classList.add('selected');

      // Close dropdown
      customSelect.classList.remove('active');

      // Add subtle animation
      selectTrigger.style.transform = 'scale(0.98)';
      setTimeout(() => {
        selectTrigger.style.transform = 'scale(1)';
      }, 100);
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!customSelect.contains(e.target)) {
        customSelect.classList.remove('active');
      }
    });

    // Keyboard navigation
    customSelect.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        customSelect.classList.toggle('active');
      } else if (e.key === 'Escape') {
        customSelect.classList.remove('active');
      }
    });

    // Make it focusable
    selectTrigger.setAttribute('tabindex', '0');
  }

  function setupFormSubmission() {
    const form = document.getElementById("guestbook-form");

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const submitBtn = form.querySelector(".btn-submit");
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<div class="loading"></div> Menyimpan...';
      submitBtn.disabled = true;

      // Collect form data
      const formData = new FormData(form);

      try {
        const response = await fetch('{% url "guest_system:guest_book" %}', {
          method: "POST",
          body: formData,
          headers: {
            "X-CSRFToken": getCookie("csrftoken"),
          },
        });

        const result = await response.json();

        if (result.status === "success") {
          showSuccessModal();

          // Give audio direction
          const purpose = document.getElementById("visit-purpose").value;
          if (purpose === "data_service") {
            speakInstruction(
              "Terima kasih. Silakan menuju ke ruang PST untuk pelayanan data."
            );
          } else {
            speakInstruction(
              "Terima kasih. Silakan langsung menemui pegawai atau kepala kantor."
            );
          }
        } else {
          alert("Error: " + result.message);
        }
      } catch (error) {
        console.error("Error submitting guest book:", error);
        alert("Error dalam pengiriman. Silakan coba lagi.");
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });
  }

  function showSuccessModal() {
    const modal = document.getElementById("success-modal");
    const directionDisplay = document.getElementById("direction-display");
    const purpose = document.getElementById("visit-purpose").value;

    let directionText = "";
    let directionIcon = "";

    if (purpose === "data_service") {
      directionText = "Silakan menuju ke Ruang PST untuk pelayanan data";
      directionIcon = "fas fa-map-marker-alt";
    } else {
      directionText = "Silakan langsung menemui pegawai atau kepala kantor";
      directionIcon = "fas fa-user-tie";
    }

    directionDisplay.innerHTML = `
            <h4><i class="${directionIcon}"></i> Petunjuk Arah:</h4>
            <p>${directionText}</p>
        `;

    modal.style.display = "flex";
  }

  function finishProcess() {
    // Redirect to home or close application
    window.location.href = '{% url "guest_system:home" %}';
  }

  function speakInstruction(text) {
    if ("speechSynthesis" in window) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "id-ID";
      utterance.rate = 0.9;
      utterance.pitch = 1;
      window.speechSynthesis.speak(utterance);
    }
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}