{% extends 'guest_system/base.html' %} {% load static %} {% block title
%}Dashboard Monitoring - Smart Guest Book {% block content %}
<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Monitoring - Smart Guest Book</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{% load static %}{% static 'css/dashboard_style.css' %}"
    />
  </head>
  <body>
    <!-- Mobile Toggle Button -->
    <button class="mobile-toggle" onclick="toggleSidebar()">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>
          <div class="icon">
            <i class="fas fa-tachometer-alt"></i>
          </div>
          Smart Guest Book
        </h2>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-item">
          <a href="#overview" class="nav-link active" data-tab="overview">
            <i class="fas fa-chart-pie"></i>
            <span>Overview</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#guests" class="nav-link" data-tab="guests">
            <i class="fas fa-users"></i>
            <span>Data Tamu</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#visits" class="nav-link" data-tab="visits">
            <i class="fas fa-door-open"></i>
            <span>Kunjungan</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="#notifications" class="nav-link" data-tab="notifications">
            <i class="fas fa-bell"></i>
            <span>Notifikasi</span>
          </a>
        </div>
        <div class="nav-item">
          <a
            href="#staff-management"
            class="nav-link"
            data-tab="staff-management"
          >
            <i class="fas fa-user-cog"></i>
            <span>Staff Management</span>
          </a>
        </div>
        <div class="nav-item">
          <a href="{% url 'guest_system:face_recognition' %}" class="nav-link">
            <i class="fas fa-camera"></i>
            <span>Face Recognition</span>
          </a>
        </div>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Top Bar -->
      <div class="top-bar">
        <div class="page-title">
          <h1>Dashboard Monitoring</h1>
          <p>
            Pantau aktivitas tamu secara real-time dengan antarmuka yang elegan
          </p>
        </div>
        <div class="top-bar-actions">
          <button class="refresh-btn" onclick="refreshDashboard()">
            <i class="fas fa-sync-alt"></i>
            <span>Refresh</span>
          </button>
          <div class="last-update">
            <i class="fas fa-clock"></i>
            <span
              >Last updated: <span id="last-update-time">--:--:--</span></span
            >
          </div>
        </div>
      </div>

      <!-- Dashboard Content -->
      <div class="dashboard-content">
        <!-- Overview Tab -->
        <div id="overview-content" class="tab-content active">
          <!-- Stats Grid -->
          <div class="stats-grid">
            <div class="stat-card total-guests">
              <div class="stat-header">
                <div>
                  <div class="stat-value" id="total-guests">--</div>
                  <div class="stat-label">Total Tamu Terdaftar</div>
                  <div class="stat-trend positive">
                    <i class="fas fa-arrow-up"></i>
                    <span>Terdaftar di sistem</span>
                  </div>
                </div>
                <div class="stat-icon">
                  <i class="fas fa-users"></i>
                </div>
              </div>
            </div>

            <div class="stat-card today-guests">
              <div class="stat-header">
                <div>
                  <div class="stat-value" id="today-guests">--</div>
                  <div class="stat-label">Tamu Hari Ini</div>
                  <div class="stat-trend positive">
                    <i class="fas fa-calendar-day"></i>
                    <span>Registrasi hari ini</span>
                  </div>
                </div>
                <div class="stat-icon">
                  <i class="fas fa-user-plus"></i>
                </div>
              </div>
            </div>

            <div class="stat-card active-visits">
              <div class="stat-header">
                <div>
                  <div class="stat-value" id="active-visits">--</div>
                  <div class="stat-label">Sedang Berkunjung</div>
                  <div class="stat-trend neutral">
                    <i class="fas fa-clock"></i>
                    <span>Aktif sekarang</span>
                  </div>
                </div>
                <div class="stat-icon">
                  <i class="fas fa-door-open"></i>
                </div>
              </div>
            </div>

            <div class="stat-card pending-guestbook">
              <div class="stat-header">
                <div>
                  <div class="stat-value" id="pending-guestbook">--</div>
                  <div class="stat-label">Belum Isi Buku Tamu</div>
                  <div class="stat-trend urgent">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Perlu perhatian</span>
                  </div>
                </div>
                <div class="stat-icon">
                  <i class="fas fa-edit"></i>
                </div>
              </div>
            </div>
          </div>

          <!-- Main Grid -->
          <div class="main-grid">
            <!-- Recent Activity -->
            <div class="panel">
              <div class="panel-header">
                <div class="panel-icon">
                  <i class="fas fa-history"></i>
                </div>
                <div class="panel-title">
                  <h3>Aktivitas Terbaru</h3>
                  <p>Real-time monitoring sistem</p>
                </div>
              </div>
              <div class="panel-body">
                <div class="activity-list" id="recent-activity">
                  <!-- Activities will be populated here -->
                </div>
              </div>
            </div>

            <!-- Statistics & Analytics -->
            <div class="panel">
              <div class="panel-header">
                <div class="panel-icon">
                  <i class="fas fa-chart-line"></i>
                </div>
                <div class="panel-title">
                  <h3>Statistik & Analytics</h3>
                  <p>Tren kunjungan harian</p>
                </div>
              </div>
              <div class="panel-body">
                <div class="charts-container">
                  <div class="chart-box">
                    <canvas id="daily-chart"></canvas>
                  </div>
                  <div class="chart-box">
                    <canvas id="purpose-chart"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Guests Tab -->
        <div id="guests-content" class="tab-content" style="display: none">
          <div class="content-section">
            <div class="panel-header">
              <div class="panel-icon">
                <i class="fas fa-users"></i>
              </div>
              <div class="panel-title">
                <h3>Manajemen Tamu</h3>
                <p>Daftar dan status tamu terdaftar</p>
              </div>
            </div>
            <div class="panel-body">
              <div class="guests-grid" id="guests-list">
                <!-- Guests will be populated here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Visits Tab -->
        <div id="visits-content" class="tab-content" style="display: none">
          <div class="content-section">
            <div class="panel-header">
              <div class="panel-icon">
                <i class="fas fa-door-open"></i>
              </div>
              <div class="panel-title">
                <h3>Kunjungan Aktif</h3>
                <p>Monitor tamu yang sedang berkunjung</p>
              </div>
            </div>
            <div class="panel-body">
              <div id="active-visits-list">
                <!-- Active visits will be populated here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Notifications Tab -->
        <div
          id="notifications-content"
          class="tab-content"
          style="display: none"
        >
          <div class="content-section">
            <div class="panel-header">
              <div class="panel-icon">
                <i class="fas fa-bell"></i>
              </div>
              <div class="panel-title">
                <h3>Notifikasi Real-time</h3>
                <p>Peringatan dan pemberitahuan sistem</p>
              </div>
            </div>
            <div class="panel-body">
              <div id="notifications-list">
                <!-- Notifications will be populated here -->
              </div>
            </div>
          </div>
        </div>
        <div
          id="staff-management-content"
          class="tab-content"
          style="display: none"
        >
          <div class="content-section">
            <div class="panel-header">
              <div class="panel-icon">
                <i class="fas fa-user-cog"></i>
              </div>
              <div class="panel-title">
                <h3>Manajemen Staff</h3>
                <p>Kelola data pegawai dan konfigurasi WhatsApp</p>
              </div>
              <div class="panel-actions">
                <button class="btn btn-primary" onclick="openAddStaffModal()">
                  <i class="fas fa-plus"></i>
                  Tambah Staff Baru
                </button>
              </div>
            </div>

            <!-- Staff Filter and Search -->
            <div class="staff-filters">
              <div class="filter-group">
                <label for="department-filter">Filter Departemen:</label>
                <select id="department-filter" onchange="filterStaff()">
                  <option value="">Semua Departemen</option>
                  <option value="kepala_kantor">Kepala Kantor</option>
                  <option value="subbag_umum">Subbag Umum & Kepegawaian</option>
                  <option value="pst">Fungsi PST</option>
                  <option value="ipds">Fungsi IPDS</option>
                  <option value="distribusi">
                    Fungsi Statistik Distribusi
                  </option>
                  <option value="produksi">Fungsi Statistik Produksi</option>
                  <option value="sosial">Fungsi Statistik Sosial</option>
                  <option value="neraca">Fungsi Neraca & Analisis</option>
                  <option value="sekretaris">Sekretaris</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="status-filter">Filter Status:</label>
                <select id="status-filter" onchange="filterStaff()">
                  <option value="">Semua Status</option>
                  <option value="available">Tersedia</option>
                  <option value="busy">Sedang Sibuk</option>
                  <option value="meeting">Sedang Rapat</option>
                  <option value="out">Sedang Keluar</option>
                  <option value="off">Tidak Masuk</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="whatsapp-filter">Filter WhatsApp:</label>
                <select id="whatsapp-filter" onchange="filterStaff()">
                  <option value="">Semua</option>
                  <option value="enabled">WhatsApp Aktif</option>
                  <option value="disabled">WhatsApp Nonaktif</option>
                </select>
              </div>

              <div class="search-group">
                <label for="staff-search">Cari Staff:</label>
                <input
                  type="text"
                  id="staff-search"
                  placeholder="Cari nama atau jabatan..."
                  onkeyup="filterStaff()"
                />
              </div>
            </div>

            <div class="panel-body">
              <div id="staff-management-list">
                <!-- Staff list will be populated here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Staff Modal for Add/Edit -->
        <div id="staff-modal" class="modal" style="display: none">
          <div class="modal-content">
            <div class="modal-header">
              <h3 id="modal-title">Tambah Staff Baru</h3>
              <button class="modal-close" onclick="closeStaffModal()">
                &times;
              </button>
            </div>

            <form id="staff-form" onsubmit="saveStaff(event)">
              <div class="modal-body">
                <input type="hidden" id="staff-id" name="staff_id" />

                <div class="form-grid">
                  <div class="form-group">
                    <label for="staff-name">Nama Lengkap *</label>
                    <input type="text" id="staff-name" name="name" required />
                  </div>

                  <div class="form-group">
                    <label for="staff-position">Jabatan *</label>
                    <input
                      type="text"
                      id="staff-position"
                      name="position"
                      required
                    />
                  </div>

                  <div class="form-group">
                    <label for="staff-department">Departemen/Fungsi *</label>
                    <select id="staff-department" name="department" required>
                      <option value="">Pilih Departemen</option>
                      <option value="kepala_kantor">Kepala Kantor</option>
                      <option value="subbag_umum">
                        Subbag Umum & Kepegawaian
                      </option>
                      <option value="pst">Fungsi PST</option>
                      <option value="ipds">Fungsi IPDS</option>
                      <option value="distribusi">
                        Fungsi Statistik Distribusi
                      </option>
                      <option value="produksi">
                        Fungsi Statistik Produksi
                      </option>
                      <option value="sosial">Fungsi Statistik Sosial</option>
                      <option value="neraca">Fungsi Neraca & Analisis</option>
                      <option value="sekretaris">Sekretaris</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="staff-phone">Nomor Telepon *</label>
                    <input
                      type="tel"
                      id="staff-phone"
                      name="phone_number"
                      required
                      placeholder="08xxxxxxxxxx atau 62xxxxxxxxxx"
                    />
                  </div>

                  <div class="form-group">
                    <label for="staff-email">Email</label>
                    <input type="email" id="staff-email" name="email" />
                  </div>

                  <div class="form-group">
                    <label for="staff-room">Ruang Kantor</label>
                    <input
                      type="text"
                      id="staff-room"
                      name="office_room"
                      placeholder="Ruang PST, Lt. 2, dll"
                    />
                  </div>

                  <div class="form-group">
                    <label for="staff-status">Status Saat Ini</label>
                    <select id="staff-status" name="current_status">
                      <option value="available">Tersedia</option>
                      <option value="busy">Sedang Sibuk</option>
                      <option value="meeting">Sedang Rapat</option>
                      <option value="out">Sedang Keluar</option>
                      <option value="off">Tidak Masuk</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="staff-status-message">Pesan Status</label>
                    <input
                      type="text"
                      id="staff-status-message"
                      name="status_message"
                      placeholder="Rapat koordinasi, Dinas luar, dll"
                    />
                  </div>
                </div>

                <div class="form-group checkbox-group">
                  <label class="checkbox-label">
                    <input
                      type="checkbox"
                      id="staff-whatsapp"
                      name="whatsapp_enabled"
                      checked
                    />
                    <span class="checkbox-custom"></span>
                    Aktifkan Notifikasi WhatsApp
                  </label>
                </div>

                <div class="form-group checkbox-group">
                  <label class="checkbox-label">
                    <input
                      type="checkbox"
                      id="staff-active"
                      name="is_active"
                      checked
                    />
                    <span class="checkbox-custom"></span>
                    Staff Aktif
                  </label>
                </div>
              </div>

              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  onclick="closeStaffModal()"
                >
                  <i class="fas fa-times"></i>
                  Batal
                </button>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i>
                  <span id="save-btn-text">Simpan</span>
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Confirm Delete Modal -->
        <div id="delete-modal" class="modal" style="display: none">
          <div class="modal-content small-modal">
            <div class="modal-header">
              <h3>Konfirmasi Hapus</h3>
              <button class="modal-close" onclick="closeDeleteModal()">
                &times;
              </button>
            </div>

            <div class="modal-body">
              <div class="delete-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <p>
                  Apakah Anda yakin ingin menghapus staff
                  <strong id="delete-staff-name"></strong>?
                </p>
                <p class="warning-text">Tindakan ini tidak dapat dibatalkan!</p>
              </div>
            </div>

            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="closeDeleteModal()"
              >
                <i class="fas fa-times"></i>
                Batal
              </button>
              <button
                type="button"
                class="btn btn-danger"
                onclick="confirmDeleteStaff()"
              >
                <i class="fas fa-trash"></i>
                Hapus
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <script>
      // Dashboard data and charts
      let dashboardData = {};
      let dailyChart = null;
      let purposeChart = null;
      let currentTab = "overview";

      // CSRF Token for Django
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      // Toggle sidebar for mobile
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("open");
      }

      // Initialize dashboard
      document.addEventListener("DOMContentLoaded", function () {
        initializeNavigation();
        initializeCharts();
        loadDashboardData();

        // Auto-refresh every 30 seconds
        setInterval(loadDashboardData, 30000);

        // Close sidebar when clicking outside on mobile
        document.addEventListener("click", function (e) {
          const sidebar = document.getElementById("sidebar");
          const toggleBtn = document.querySelector(".mobile-toggle");

          if (
            window.innerWidth <= 1024 &&
            !sidebar.contains(e.target) &&
            !toggleBtn.contains(e.target) &&
            sidebar.classList.contains("open")
          ) {
            sidebar.classList.remove("open");
          }
        });
      });

      // Navigation functionality
      function initializeNavigation() {
        const navLinks = document.querySelectorAll(".nav-link[data-tab]");

        navLinks.forEach((link) => {
          link.addEventListener("click", function (e) {
            e.preventDefault();
            const tabName = this.dataset.tab;
            switchTab(tabName);

            // Close sidebar on mobile after tab switch
            if (window.innerWidth <= 1024) {
              document.getElementById("sidebar").classList.remove("open");
            }
          });
        });
      }

      function switchTab(tabName) {
        // Update navigation
        document.querySelectorAll(".nav-link").forEach((link) => {
          link.classList.remove("active");
        });
        document
          .querySelector(`[data-tab="${tabName}"]`)
          .classList.add("active");

        // Update content
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.style.display = "none";
        });
        document.getElementById(`${tabName}-content`).style.display = "block";

        currentTab = tabName;
      }

      // Load dashboard data from Django backend
      async function loadDashboardData() {
        try {
          const response = await fetch(
            '{% url "guest_system:dashboard_data" %}',
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
              },
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (result.status === "success") {
            dashboardData = result.data;
            updateDashboard();
            updateLastUpdateTime();
          } else {
            throw new Error(result.message || "Failed to load dashboard data");
          }
        } catch (error) {
          console.error("Error loading dashboard data:", error);
          showToast("Gagal memuat data dashboard: " + error.message, "error");
        }
      }

      // Update all dashboard components
      function updateDashboard() {
        updateStatistics();
        updateRecentActivity();
        updateGuestsList();
        updateActiveVisits();
        updateNotifications();
        updateCharts();
      }

      // Update statistics cards
      function updateStatistics() {
        if (dashboardData.statistics) {
          document.getElementById("total-guests").textContent =
            dashboardData.statistics.total_guests;
          document.getElementById("today-guests").textContent =
            dashboardData.statistics.today_guests;
          document.getElementById("active-visits").textContent =
            dashboardData.statistics.active_visits;
          document.getElementById("pending-guestbook").textContent =
            dashboardData.statistics.pending_guestbook;
        }
      }

      // Update recent activity
      function updateRecentActivity() {
        const container = document.getElementById("recent-activity");
        container.innerHTML = "";

        if (
          !dashboardData.notifications ||
          dashboardData.notifications.length === 0
        ) {
          container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <h3>Belum Ada Aktivitas</h3>
                        <p>Aktivitas sistem akan muncul di sini</p>
                    </div>
                `;
          return;
        }

        // Show latest 5 notifications as activities
        const activities = dashboardData.notifications.slice(0, 5);

        activities.forEach((activity) => {
          const iconClass = getNotificationIcon(activity.type);
          const item = document.createElement("div");
          item.className = "activity-item";

          item.innerHTML = `
                    <div class="activity-icon-small">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="activity-content">
                        <h4>${activity.title}</h4>
                        <p>${activity.message}</p>
                        <div class="activity-time">${activity.time_ago}</div>
                    </div>
                `;

          container.appendChild(item);
        });
      }

      // Update guests list
      function updateGuestsList() {
        const container = document.getElementById("guests-list");
        container.innerHTML = "";

        if (
          !dashboardData.recent_guests ||
          dashboardData.recent_guests.length === 0
        ) {
          container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>Belum Ada Tamu</h3>
                        <p>Tamu yang terdaftar akan muncul di sini</p>
                    </div>
                `;
          return;
        }

        dashboardData.recent_guests.forEach((guest) => {
          const card = document.createElement("div");
          card.className = "guest-card";

          const initials = guest.name
            .split(" ")
            .map((n) => n[0])
            .join("")
            .substring(0, 2);
          const statusClass = `status-${guest.status.replace("_", "-")}`;

          card.innerHTML = `
                    <div class="guest-header">
                        <div class="guest-avatar">
                            ${
                              guest.face_image_url
                                ? `<img src="${guest.face_image_url}" alt="${guest.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`
                                : initials
                            }
                        </div>
                        <div class="guest-info">
                            <h4>${guest.name}</h4>
                            <p>${guest.company || "Tidak ada perusahaan"}</p>
                        </div>
                    </div>
                    <div class="guest-meta">
                        <div class="guest-time">Terdaftar: ${
                          guest.registration_time
                        }</div>
                        <div class="status-badge ${statusClass}">
                            ${guest.status_info.text}
                        </div>
                    </div>
                    <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
                        ${
                          guest.status === "pending_guestbook"
                            ? `<button class="btn btn-warning" onclick="sendReminder(${guest.id})">
                                <i class="fas fa-bell"></i> Kirim Pengingat
                            </button>`
                            : ""
                        }
                        ${
                          guest.status === "active_visit"
                            ? `<button class="btn btn-danger" onclick="checkoutGuest(${guest.id})">
                                <i class="fas fa-sign-out-alt"></i> Check Out
                            </button>`
                            : ""
                        }
                    </div>
                `;

          container.appendChild(card);
        });
      }

      // Update active visits
      function updateActiveVisits() {
        const container = document.getElementById("active-visits-list");
        container.innerHTML = "";

        if (
          !dashboardData.active_visits ||
          dashboardData.active_visits.length === 0
        ) {
          container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-door-open"></i>
                        <h3>Tidak Ada Kunjungan Aktif</h3>
                        <p>Kunjungan yang sedang berlangsung akan muncul di sini</p>
                    </div>
                `;
          return;
        }

        dashboardData.active_visits.forEach((visit) => {
          const urgencyColor = {
            low: "#10b981",
            medium: "#f59e0b",
            high: "#ef4444",
          };

          const item = document.createElement("div");
          item.className = "guest-card";
          item.style.borderLeft = `4px solid ${
            urgencyColor[visit.urgency_level]
          }`;

          item.innerHTML = `
                    <div class="guest-header">
                        <div class="guest-avatar">
                            ${visit.guest_name
                              .split(" ")
                              .map((n) => n[0])
                              .join("")
                              .substring(0, 2)}
                        </div>
                        <div class="guest-info">
                            <h4>${visit.guest_name}</h4>
                            <p>${visit.purpose}</p>
                        </div>
                    </div>
                    <div class="guest-meta">
                        <div class="guest-time">
                            Check-in: ${visit.check_in_time} | Durasi: ${
            visit.duration_minutes
          } menit
                        </div>
                        <div class="status-badge ${
                          visit.is_overdue ? "status-pending" : "status-active"
                        }">
                            ${visit.is_overdue ? "Terlambat" : "Aktif"}
                        </div>
                    </div>
                `;

          container.appendChild(item);
        });
      }

      // Update notifications
      function updateNotifications() {
        const container = document.getElementById("notifications-list");
        container.innerHTML = "";

        if (
          !dashboardData.notifications ||
          dashboardData.notifications.length === 0
        ) {
          container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell"></i>
                        <h3>Tidak Ada Notifikasi</h3>
                        <p>Notifikasi sistem akan muncul di sini</p>
                    </div>
                `;
          return;
        }

        dashboardData.notifications.forEach((notification) => {
          const iconClass = getNotificationIcon(notification.type);
          const isUrgent = notification.type === "guestbook_reminder";

          const item = document.createElement("div");
          item.className = `activity-item ${isUrgent ? "urgent" : ""} ${
            !notification.is_read ? "unread" : ""
          }`;
          item.style.cursor = "pointer";
          item.onclick = () => markNotificationRead(notification.id);

          item.innerHTML = `
                    <div class="activity-icon-small" style="background: ${
                      isUrgent ? "#ef4444" : "#3b82f6"
                    }">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="activity-content">
                        <h4>${notification.title} ${
            !notification.is_read
              ? '<span style="color: #ef4444;">‚óè</span>'
              : ""
          }</h4>
                        <p><strong>${notification.guest_name}:</strong> ${
            notification.message
          }</p>
                        <div class="activity-time">${
                          notification.time_ago
                        }</div>
                    </div>
                `;

          container.appendChild(item);
        });
      }

      // Initialize charts
      function initializeCharts() {
        // Daily registrations chart
        const dailyCtx = document
          .getElementById("daily-chart")
          .getContext("2d");
        dailyChart = new Chart(dailyCtx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Registrasi Harian",
                data: [],
                borderColor: "#3b82f6",
                backgroundColor: "rgba(59, 130, 246, 0.1)",
                tension: 0.4,
                fill: true,
                borderWidth: 3,
                pointBackgroundColor: "#3b82f6",
                pointBorderColor: "#ffffff",
                pointBorderWidth: 2,
                pointRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: "Registrasi Harian (7 Hari Terakhir)",
                font: {
                  size: 14,
                  weight: "bold",
                },
              },
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                },
              },
            },
          },
        });

        // Purpose breakdown chart
        const purposeCtx = document
          .getElementById("purpose-chart")
          .getContext("2d");
        purposeChart = new Chart(purposeCtx, {
          type: "doughnut",
          data: {
            labels: [],
            datasets: [
              {
                data: [],
                backgroundColor: ["#3b82f6", "#10b981", "#f59e0b", "#ef4444"],
                borderWidth: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              title: {
                display: true,
                text: "Tujuan Kunjungan Hari Ini",
                font: {
                  size: 14,
                  weight: "bold",
                },
              },
              legend: {
                position: "bottom",
                labels: {
                  padding: 20,
                  usePointStyle: true,
                },
              },
            },
          },
        });
      }

      // Update charts with real data
      function updateCharts() {
        // Update daily chart
        if (dailyChart && dashboardData.daily_stats) {
          dailyChart.data.labels = dashboardData.daily_stats.map(
            (stat) => stat.day
          );
          dailyChart.data.datasets[0].data = dashboardData.daily_stats.map(
            (stat) => stat.registrations
          );
          dailyChart.update();
        }

        // Update purpose chart
        if (purposeChart && dashboardData.purpose_breakdown) {
          purposeChart.data.labels = dashboardData.purpose_breakdown.map(
            (stat) => stat.purpose_display
          );
          purposeChart.data.datasets[0].data =
            dashboardData.purpose_breakdown.map((stat) => stat.count);
          purposeChart.update();
        }
      }

      // Helper functions
      function getNotificationIcon(type) {
        const icons = {
          new_registration: "fas fa-user-plus",
          guestbook_reminder: "fas fa-exclamation-triangle",
          guestbook_completed: "fas fa-check-circle",
          guest_checkout: "fas fa-sign-out-alt",
          long_visit: "fas fa-clock",
        };
        return icons[type] || "fas fa-bell";
      }

      function updateLastUpdateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString("id-ID", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
        document.getElementById("last-update-time").textContent = timeString;
      }

      // Action functions
      async function sendReminder(guestId) {
        try {
          const response = await fetch(
            `{% url 'guest_system:send_reminder' guest_id=0 %}`.replace(
              "0",
              guestId
            ),
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
              },
            }
          );

          const result = await response.json();

          if (result.status === "success") {
            showToast("Pengingat berhasil dikirim!", "success");
            loadDashboardData(); // Refresh data
          } else {
            throw new Error(result.message || "Gagal mengirim pengingat");
          }
        } catch (error) {
          console.error("Error sending reminder:", error);
          showToast("Gagal mengirim pengingat: " + error.message, "error");
        }
      }

      async function checkoutGuest(guestId) {
        if (!confirm("Apakah Anda yakin ingin checkout tamu ini?")) {
          return;
        }

        try {
          const response = await fetch(
            `{% url 'guest_system:checkout_guest' guest_id=0 %}`.replace(
              "0",
              guestId
            ),
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
              },
              body: JSON.stringify({
                checkout_notes: "",
              }),
            }
          );

          const result = await response.json();

          if (result.status === "success") {
            showToast("Tamu berhasil di-checkout!", "success");
            loadDashboardData(); // Refresh data
          } else {
            throw new Error(result.message || "Gagal checkout tamu");
          }
        } catch (error) {
          console.error("Error checking out guest:", error);
          showToast("Gagal checkout tamu: " + error.message, "error");
        }
      }

      async function markNotificationRead(notificationId) {
        try {
          await fetch(
            `{% url 'guest_system:mark_notification_read' notification_id=0 %}`.replace(
              "0",
              notificationId
            ),
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
              },
            }
          );

          loadDashboardData(); // Refresh data
        } catch (error) {
          console.error("Error marking notification as read:", error);
        }
      }

      // Refresh dashboard
      async function refreshDashboard() {
        const refreshBtn = document.querySelector(".refresh-btn");
        const originalHTML = refreshBtn.innerHTML;

        refreshBtn.innerHTML =
          '<div class="loading"></div> <span>Memuat...</span>';
        refreshBtn.disabled = true;

        try {
          await loadDashboardData();
          showToast("Dashboard berhasil diperbarui!", "success");
        } catch (error) {
          showToast("Gagal memperbarui dashboard: " + error.message, "error");
        } finally {
          refreshBtn.innerHTML = originalHTML;
          refreshBtn.disabled = false;
        }
      }

      // Toast notification system
      function showToast(message, type = "success") {
        // Remove existing toasts
        document.querySelectorAll(".toast").forEach((toast) => toast.remove());

        const toast = document.createElement("div");
        toast.className = `toast ${type}`;

        const iconClass =
          type === "success" ? "fa-check-circle" : "fa-exclamation-circle";

        toast.innerHTML = `
                <i class="fas ${iconClass}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; margin-left: auto; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;

        document.body.appendChild(toast);

        // Auto remove after 4 seconds
        setTimeout(() => {
          if (toast.parentElement) {
            toast.remove();
          }
        }, 4000);
      }

      // Keyboard shortcuts
      document.addEventListener("keydown", function (e) {
        // Ctrl/Cmd + R to refresh
        if ((e.ctrlKey || e.metaKey) && e.key === "r") {
          e.preventDefault();
          refreshDashboard();
        }

        // Number keys 1-4 to switch tabs
        if (
          e.key >= "1" &&
          e.key <= "4" &&
          !e.ctrlKey &&
          !e.metaKey &&
          !e.altKey
        ) {
          const tabNames = ["overview", "guests", "visits", "notifications"];
          const tabIndex = parseInt(e.key) - 1;
          if (tabNames[tabIndex]) {
            switchTab(tabNames[tabIndex]);
          }
        }

        // Escape key to close sidebar on mobile
        if (e.key === "Escape" && window.innerWidth <= 1024) {
          document.getElementById("sidebar").classList.remove("open");
        }
      });

      let staffData = [];
      let filteredStaffData = [];
      let editingStaffId = null;
      let deleteStaffId = null;

      // Enhanced loading state
      function showLoadingCards(count = 6) {
        const container = document.getElementById("staff-management-list");
        const loadingHTML = Array(count)
          .fill(0)
          .map(
            () => `
    <div class="loading-card">
      <div class="loading-header">
        <div class="loading-avatar"></div>
        <div class="loading-info">
          <div class="loading-line medium"></div>
          <div class="loading-line short"></div>
          <div class="loading-line long"></div>
        </div>
      </div>
      <div class="loading-line long"></div>
      <div class="loading-line medium"></div>
      <div class="loading-line short"></div>
    </div>
  `
          )
          .join("");

        container.innerHTML = `<div class="staff-grid">${loadingHTML}</div>`;
      }

      // Enhanced load staff data with loading state
      async function loadStaffData() {
        try {
          showLoadingCards();

          const response = await fetch("/api/get-staff-list/", {
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (result.status === "success") {
            staffData = result.data;
            filteredStaffData = [...staffData];

            // Add slight delay for better UX
            setTimeout(() => {
              renderStaffList();
              updateFilterResultCount();
            }, 300);
          } else {
            throw new Error(result.message || "Failed to load staff data");
          }
        } catch (error) {
          console.error("Error loading staff data:", error);
          showToast("Gagal memuat data staff: " + error.message, "error");

          // Show error state
          const container = document.getElementById("staff-management-list");
          container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-exclamation-triangle"></i>
        <h3>Gagal Memuat Data</h3>
        <p>Terjadi kesalahan saat memuat data staff: ${error.message}</p>
        <button class="btn btn-primary" onclick="loadStaffData()" style="margin-top: 1rem;">
          <i class="fas fa-redo"></i> Coba Lagi
        </button>
      </div>
    `;
        }
      }

      // Enhanced render with animations
      function renderStaffList() {
        const container = document.getElementById("staff-management-list");

        if (!filteredStaffData || filteredStaffData.length === 0) {
          container.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-users"></i>
        <h3>Tidak Ada Staff</h3>
        <p>Belum ada data staff yang sesuai dengan filter yang diterapkan</p>
        <button class="btn btn-primary" onclick="openAddStaffModal()" style="margin-top: 1rem;">
          <i class="fas fa-plus"></i> Tambah Staff Pertama
        </button>
      </div>
    `;
          return;
        }

        const staffGrid = document.createElement("div");
        staffGrid.className = "staff-grid";

        filteredStaffData.forEach((staff, index) => {
          const card = document.createElement("div");
          card.innerHTML = createStaffCard(staff);
          card.style.animationDelay = `${index * 0.1}s`;
          card.style.animation = "fadeInUp 0.5s ease forwards";
          card.style.opacity = "0";
          staffGrid.appendChild(card.firstElementChild);
        });

        container.innerHTML = "";
        container.appendChild(staffGrid);
      }

      // Create staff card HTML
      function createStaffCard(staff) {
        const initials = staff.name
          .split(" ")
          .map((n) => n[0])
          .join("")
          .substring(0, 2);
        const statusText = getStatusText(staff.current_status);
        const departmentText = getDepartmentText(staff.department);

        return `
    <div class="staff-management-card ${staff.current_status}" data-staff-id="${
          staff.id
        }">
      <div class="staff-card-header">
        <div class="staff-avatar-large">
          ${
            staff.photo
              ? `<img src="${staff.photo}" alt="${staff.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 16px;">`
              : initials
          }
        </div>
        <div class="staff-main-info">
          <h4>${staff.name}</h4>
          <div class="position">${staff.position}</div>
          <div class="department">${departmentText}</div>
        </div>
      </div>
      
      <div class="staff-details">
        <div class="detail-row">
          <i class="fas fa-phone"></i>
          <span>${staff.phone_number}</span>
        </div>
        ${
          staff.email
            ? `
          <div class="detail-row">
            <i class="fas fa-envelope"></i>
            <span>${staff.email}</span>
          </div>
        `
            : ""
        }
        ${
          staff.office_room
            ? `
          <div class="detail-row">
            <i class="fas fa-map-marker-alt"></i>
            <span>${staff.office_room}</span>
          </div>
        `
            : ""
        }
        ${
          staff.statistics
            ? `
          <div class="detail-row">
            <i class="fas fa-chart-bar"></i>
            <span>${staff.statistics.total_visits} total kunjungan, ${staff.statistics.active_visits} aktif</span>
          </div>
        `
            : ""
        }
      </div>
      
      <div class="status-row">
        <div class="current-status">
          <span class="status-dot ${staff.current_status}"></span>
          <span>${statusText}</span>
          ${
            staff.status_message
              ? `<span class="status-message">- ${staff.status_message}</span>`
              : ""
          }
        </div>
        <div class="whatsapp-badge ${
          staff.whatsapp_enabled ? "enabled" : "disabled"
        }">
          <i class="fab fa-whatsapp"></i>
          <span>${staff.whatsapp_enabled ? "Aktif" : "Nonaktif"}</span>
        </div>
      </div>
      
      <div class="staff-actions">
        ${
          staff.whatsapp_enabled
            ? `
          <button class="btn-icon btn-whatsapp" onclick="testWhatsApp(${staff.id})" title="Test WhatsApp">
            <i class="fab fa-whatsapp"></i>
          </button>
        `
            : ""
        }
        <button class="btn-icon btn-edit" onclick="editStaff(${
          staff.id
        })" title="Edit Staff">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn-icon btn-delete" onclick="deleteStaff(${
          staff.id
        })" title="Hapus Staff">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </div>
  `;
      }

      // Helper functions
      function getStatusText(status) {
        const statusMap = {
          available: "Tersedia",
          busy: "Sedang Sibuk",
          meeting: "Sedang Rapat",
          out: "Sedang Keluar",
          off: "Tidak Masuk",
        };
        return statusMap[status] || status;
      }

      function getDepartmentText(department) {
        const departmentMap = {
          kepala_kantor: "Kepala Kantor",
          subbag_umum: "Subbag Umum & Kepegawaian",
          pst: "Fungsi PST",
          ipds: "Fungsi IPDS",
          distribusi: "Fungsi Statistik Distribusi",
          produksi: "Fungsi Statistik Produksi",
          sosial: "Fungsi Statistik Sosial",
          neraca: "Fungsi Neraca & Analisis",
          sekretaris: "Sekretaris",
        };
        return departmentMap[department] || department;
      }

      // Enhanced filter function with debouncing
      let filterTimeout;
      function filterStaff() {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(() => {
          const departmentFilter =
            document.getElementById("department-filter").value;
          const statusFilter = document.getElementById("status-filter").value;
          const whatsappFilter =
            document.getElementById("whatsapp-filter").value;
          const searchTerm = document
            .getElementById("staff-search")
            .value.toLowerCase()
            .trim();

          filteredStaffData = staffData.filter((staff) => {
            const matchDepartment =
              !departmentFilter || staff.department === departmentFilter;
            const matchStatus =
              !statusFilter || staff.current_status === statusFilter;
            const matchWhatsApp =
              !whatsappFilter ||
              (whatsappFilter === "enabled" && staff.whatsapp_enabled) ||
              (whatsappFilter === "disabled" && !staff.whatsapp_enabled);
            const matchSearch =
              !searchTerm ||
              staff.name.toLowerCase().includes(searchTerm) ||
              staff.position.toLowerCase().includes(searchTerm) ||
              staff.email?.toLowerCase().includes(searchTerm) ||
              staff.office_room?.toLowerCase().includes(searchTerm);

            return (
              matchDepartment && matchStatus && matchWhatsApp && matchSearch
            );
          });

          renderStaffList();
          updateFilterResultCount();
        }, 300);
      }

      // Add result count display
      function updateFilterResultCount() {
        let resultText = `Menampilkan ${filteredStaffData.length} dari ${staffData.length} staff`;

        const panelHeader = document.querySelector(
          "#staff-management-content .panel-header"
        );
        let resultIndicator = panelHeader.querySelector(".result-indicator");

        if (!resultIndicator) {
          resultIndicator = document.createElement("div");
          resultIndicator.className = "result-indicator";
          resultIndicator.style.cssText = `
      font-size: 0.875rem;
      color: #64748b;
      background: #f1f5f9;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      border: 1px solid #e2e8f0;
      margin-left: 1rem;
    `;
          panelHeader.appendChild(resultIndicator);
        }

        resultIndicator.textContent = resultText;
      }

      // Reset filters function
      function resetFilters() {
        document.getElementById("department-filter").value = "";
        document.getElementById("status-filter").value = "";
        document.getElementById("whatsapp-filter").value = "";
        document.getElementById("staff-search").value = "";
        filterStaff();
      }

      // Enhanced modal functions with better UX
      function openAddStaffModal() {
        editingStaffId = null;
        document.getElementById("modal-title").textContent =
          "Tambah Staff Baru";
        document.getElementById("save-btn-text").textContent = "Simpan";

        const form = document.getElementById("staff-form");
        form.reset();

        // Set defaults
        document.getElementById("staff-status").value = "available";
        document.getElementById("staff-whatsapp").checked = true;
        document.getElementById("staff-active").checked = true;

        document.getElementById("staff-modal").style.display = "flex";

        // Focus on first input
        setTimeout(() => {
          document.getElementById("staff-name").focus();
        }, 100);
      }

      function editStaff(staffId) {
        const staff = staffData.find((s) => s.id === staffId);
        if (!staff) return;

        editingStaffId = staffId;
        document.getElementById(
          "modal-title"
        ).textContent = `Edit Staff: ${staff.name}`;
        document.getElementById("save-btn-text").textContent = "Update";

        // Populate form with enhanced error handling
        try {
          document.getElementById("staff-id").value = staff.id;
          document.getElementById("staff-name").value = staff.name || "";
          document.getElementById("staff-position").value =
            staff.position || "";
          document.getElementById("staff-department").value =
            staff.department || "";
          document.getElementById("staff-phone").value =
            staff.phone_number || "";
          document.getElementById("staff-email").value = staff.email || "";
          document.getElementById("staff-room").value = staff.office_room || "";
          document.getElementById("staff-status").value =
            staff.current_status || "available";
          document.getElementById("staff-status-message").value =
            staff.status_message || "";
          document.getElementById("staff-whatsapp").checked =
            staff.whatsapp_enabled;
          document.getElementById("staff-active").checked = staff.is_active;
        } catch (error) {
          console.error("Error populating form:", error);
          showToast("Error saat memuat data staff", "error");
          return;
        }

        document.getElementById("staff-modal").style.display = "flex";

        // Focus on name input
        setTimeout(() => {
          document.getElementById("staff-name").focus();
          document.getElementById("staff-name").select();
        }, 100);
      }

      // Enhanced modal close with animation
      function closeStaffModal() {
        const modal = document.getElementById("staff-modal");
        const modalContent = modal.querySelector(".modal-content");

        modalContent.style.animation = "slideOutModal 0.3s ease forwards";
        setTimeout(() => {
          modal.style.display = "none";
          modalContent.style.animation = "";
          editingStaffId = null;
        }, 300);
      }

      function deleteStaff(staffId) {
        const staff = staffData.find((s) => s.id === staffId);
        if (!staff) return;

        deleteStaffId = staffId;
        document.getElementById("delete-staff-name").textContent = staff.name;
        document.getElementById("delete-modal").style.display = "flex";
      }

      function closeDeleteModal() {
        const modal = document.getElementById("delete-modal");
        const modalContent = modal.querySelector(".modal-content");

        modalContent.style.animation = "slideOutModal 0.3s ease forwards";
        setTimeout(() => {
          modal.style.display = "none";
          modalContent.style.animation = "";
          deleteStaffId = null;
        }, 300);
      }

      // Enhanced save staff with better validation and UX
      async function saveStaff(event) {
        event.preventDefault();

        const saveBtn = event.target.querySelector('button[type="submit"]');
        const originalText = saveBtn.innerHTML;

        // Show loading state
        saveBtn.innerHTML =
          '<div class="loading"></div> <span>Menyimpan...</span>';
        saveBtn.disabled = true;

        const formData = new FormData(event.target);

        // Enhanced validation
        const validationErrors = [];

        // Name validation
        const name = formData.get("name").trim();
        if (!name) {
          validationErrors.push("Nama wajib diisi");
        } else if (name.length < 3) {
          validationErrors.push("Nama minimal 3 karakter");
        }

        // Phone validation
        const phone = formData.get("phone_number").trim();
        const phoneRegex = /^(\+62|62|0)[0-9]{8,12}$/;
        if (!phone) {
          validationErrors.push("Nomor telepon wajib diisi");
        } else if (!phoneRegex.test(phone)) {
          validationErrors.push(
            "Format nomor telepon tidak valid (gunakan 08xxx, 62xxx, atau +62xxx)"
          );
        }

        // Email validation (if provided)
        const email = formData.get("email").trim();
        if (email) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(email)) {
            validationErrors.push("Format email tidak valid");
          }
        }

        // Department validation
        const department = formData.get("department");
        if (!department) {
          validationErrors.push("Departemen wajib dipilih");
        }

        // Position validation
        const position = formData.get("position").trim();
        if (!position) {
          validationErrors.push("Jabatan wajib diisi");
        }

        if (validationErrors.length > 0) {
          saveBtn.innerHTML = originalText;
          saveBtn.disabled = false;
          showToast("Validasi gagal: " + validationErrors.join(", "), "error");
          return;
        }

        const staffDataPayload = {
          name: name,
          position: position,
          department: department,
          phone_number: phone,
          email: email || null,
          office_room: formData.get("office_room").trim() || null,
          current_status: formData.get("current_status"),
          status_message: formData.get("status_message").trim() || null,
          whatsapp_enabled: formData.get("whatsapp_enabled") === "on",
          is_active: formData.get("is_active") === "on",
        };

        try {
          let url, method;
          if (editingStaffId) {
            url = `/api/staff/${editingStaffId}/update/`;
            method = "PUT";
            staffDataPayload.id = editingStaffId;
          } else {
            url = "/api/staff/create/";
            method = "POST";
          }

          const response = await fetch(url, {
            method: method,
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify(staffDataPayload),
          });

          const result = await response.json();

          if (result.status === "success") {
            showToast(
              editingStaffId
                ? `Data ${staffDataPayload.name} berhasil diperbarui!`
                : `Staff ${staffDataPayload.name} berhasil ditambahkan!`,
              "success"
            );

            closeStaffModal();

            // Refresh data with animation
            await loadStaffData();

            // Reset filters if adding new staff
            if (!editingStaffId) {
              resetFilters();
            }
          } else {
            throw new Error(result.message || "Gagal menyimpan data staff");
          }
        } catch (error) {
          console.error("Error saving staff:", error);
          showToast("Gagal menyimpan data staff: " + error.message, "error");
        } finally {
          saveBtn.innerHTML = originalText;
          saveBtn.disabled = false;
        }
      }

      // Enhanced delete with better confirmation
      async function confirmDeleteStaff() {
        if (!deleteStaffId) return;

        const deleteBtn = document.querySelector("#delete-modal .btn-danger");
        const originalText = deleteBtn.innerHTML;

        deleteBtn.innerHTML =
          '<div class="loading"></div> <span>Menghapus...</span>';
        deleteBtn.disabled = true;

        try {
          const response = await fetch(`/api/staff/${deleteStaffId}/delete/`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
          });

          const result = await response.json();

          if (result.status === "success") {
            const staffName =
              staffData.find((s) => s.id === deleteStaffId)?.name || "Staff";
            showToast(`${staffName} berhasil dihapus!`, "success");

            closeDeleteModal();

            // Remove from local data with animation
            const cardElement = document.querySelector(
              `[data-staff-id="${deleteStaffId}"]`
            );
            if (cardElement) {
              cardElement.style.animation = "fadeOutDown 0.3s ease forwards";
              setTimeout(() => {
                loadStaffData();
              }, 300);
            } else {
              loadStaffData();
            }
          } else {
            throw new Error(result.message || "Gagal menghapus staff");
          }
        } catch (error) {
          console.error("Error deleting staff:", error);
          showToast("Gagal menghapus staff: " + error.message, "error");
        } finally {
          deleteBtn.innerHTML = originalText;
          deleteBtn.disabled = false;
        }
      }

      // Enhanced WhatsApp test with better feedback
      async function testWhatsApp(staffId) {
        const staff = staffData.find((s) => s.id === staffId);
        if (!staff) return;

        // Find and disable the WhatsApp button
        const whatsappBtn = document.querySelector(
          `[data-staff-id="${staffId}"] .btn-whatsapp`
        );
        const originalContent = whatsappBtn.innerHTML;

        whatsappBtn.innerHTML = '<div class="loading"></div>';
        whatsappBtn.disabled = true;

        try {
          showToast(`Mengirim test WhatsApp ke ${staff.name}...`, "info");

          const response = await fetch(`/api/staff/${staffId}/test-whatsapp/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
          });

          const result = await response.json();

          if (result.status === "success") {
            showToast(
              `‚úÖ Test WhatsApp berhasil dikirim ke ${staff.name}!`,
              "success"
            );

            // Add visual feedback to the card
            const card = document.querySelector(`[data-staff-id="${staffId}"]`);
            card.style.animation = "pulse 0.5s ease";
            setTimeout(() => {
              card.style.animation = "";
            }, 500);
          } else {
            throw new Error(result.message || "Gagal mengirim test WhatsApp");
          }
        } catch (error) {
          console.error("Error testing WhatsApp:", error);
          showToast(
            `‚ùå Gagal mengirim test WhatsApp: ${error.message}`,
            "error"
          );
        } finally {
          whatsappBtn.innerHTML = originalContent;
          whatsappBtn.disabled = false;
        }
      }

      // Initialize staff management when tab is selected
      function initializeStaffManagement() {
        if (currentTab === "staff-management" && staffData.length === 0) {
          loadStaffData();
        }
      }

      // Update tab switching to load staff data when needed
      const originalSwitchTab = switchTab;
      switchTab = function (tabName) {
        originalSwitchTab(tabName);
        if (tabName === "staff-management") {
          initializeStaffManagement();
        }
      };

      // Enhanced phone number formatting
      function formatPhoneInput() {
        const phoneInput = document.getElementById("staff-phone");
        if (!phoneInput) return;

        phoneInput.addEventListener("input", function (e) {
          let value = e.target.value.replace(/\D/g, ""); // Remove non-digits

          // Limit length
          if (value.length > 16) {
            value = value.substring(0, 16);
          }

          e.target.value = value;
        });
      }

      // Close modals when clicking outside
      document.addEventListener("click", function (e) {
        if (e.target.classList.contains("modal")) {
          if (e.target.id === "staff-modal") {
            closeStaffModal();
          } else if (e.target.id === "delete-modal") {
            closeDeleteModal();
          }
        }
      });

      // Close modals with Escape key
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          closeStaffModal();
          closeDeleteModal();
        }

        // Enhanced keyboard shortcuts for staff management
        if (currentTab === "staff-management") {
          // Ctrl+N to add new staff
          if ((e.ctrlKey || e.metaKey) && e.key === "n") {
            e.preventDefault();
            openAddStaffModal();
          }

          // Ctrl+F to focus search
          if ((e.ctrlKey || e.metaKey) && e.key === "f") {
            e.preventDefault();
            document.getElementById("staff-search").focus();
          }

          // Ctrl+R to reset filters (only if not refreshing page)
          if ((e.ctrlKey || e.metaKey) && e.key === "r" && e.shiftKey) {
            e.preventDefault();
            resetFilters();
          }
        }
      });

      // Add CSS animations
      const additionalCSS = `
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeOutDown {
  from {
    opacity: 1;
    transform: translateY(0);
  }
  to {
    opacity: 0;
    transform: translateY(30px);
  }
}

@keyframes slideOutModal {
  from {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
  to {
    opacity: 0;
    transform: scale(0.8) translateY(50px);
  }
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.toast.info {
  border-left-color: #3b82f6;
  background: linear-gradient(135deg, #dbeafe, #bfdbfe);
  color: #1e40af;
}
`;

      // Inject CSS if not already present
      if (!document.querySelector("#staff-management-css")) {
        const styleSheet = document.createElement("style");
        styleSheet.id = "staff-management-css";
        styleSheet.textContent = additionalCSS;
        document.head.appendChild(styleSheet);
      }

      // Initialize phone formatting when modal opens
      document.addEventListener("DOMContentLoaded", function () {
        const staffModal = document.getElementById("staff-modal");
        if (staffModal) {
          const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
              if (
                mutation.type === "attributes" &&
                mutation.attributeName === "style"
              ) {
                if (staffModal.style.display === "flex") {
                  setTimeout(formatPhoneInput, 100);
                }
              }
            });
          });

          observer.observe(staffModal, { attributes: true });
        }
      });

      // Console log for debugging
      console.log("üöÄ Smart Guest Book Dashboard Loaded");
      console.log("üìä Auto-refresh: 30 seconds");
      console.log("‚å®Ô∏è Keyboard shortcuts:");
      console.log("   - Ctrl+R: Refresh dashboard");
      console.log("   - 1-4: Switch tabs");
      console.log("   - Escape: Close sidebar (mobile)");
    </script>
  </body>
</html>
{% endblock %}
